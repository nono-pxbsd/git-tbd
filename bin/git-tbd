#!/bin/bash

# git-tbd : un mini outil CLI pour g√©rer un workflow Trunk-Based Development üöÄ

BOLD="\e[1m"
GREEN="\e[32m"
YELLOW="\e[33m"
RESET="\e[0m"

function print_help() {
  echo -e "${BOLD}git-tbd${RESET} - CLI pour workflow Trunk-Based Development\n"
  echo "Usage:"
  echo "  git-tbd start <feature-name>   ‚Üí Cr√©e une branche feature/<feature-name>"
  echo "  git-tbd finish                 ‚Üí Merge dans main + suppression de la branche"
  echo "  git-tbd sync                   ‚Üí Met √† jour la branche courante depuis main"
  echo "  git-tbd help                   ‚Üí Affiche cette aide"
}

function start_feature() {
  local name="$1"
  if [ -z "$name" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Tu dois sp√©cifier un nom de feature.${RESET}"
    exit 1
  fi
  git checkout main && git pull
  git checkout -b "feature/$name"
  echo -e "${GREEN}‚úÖ Branche cr√©√©e : feature/$name${RESET}"
}

function finish_feature() {
  local current=$(git rev-parse --abbrev-ref HEAD)
  if [[ "$current" != feature/* ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Tu dois √™tre sur une branche feature/* pour finir.${RESET}"
    exit 1
  fi
  git checkout main && git pull
  git merge --no-ff "$current" -m "Merge $current"
  git branch -d "$current"
  git push
  echo -e "${GREEN}‚úÖ Feature merg√©e et supprim√©e : $current${RESET}"
}

function sync_branch() {
  git fetch origin
  git rebase origin/main
  echo -e "${GREEN}üîÑ Branche synchronis√©e avec main.${RESET}"
}

function open_pr() {
  local branch=$(git rev-parse --abbrev-ref HEAD)

  branch_type=$(echo "$branch" | cut -d'/' -f1)
  branch_name=${branch#"$branch_type"/}

  case "$branch_type" in
    feature) prefix="‚ú® feat" ;;
    fix)     prefix="üêõ fix" ;;
    hotfix)  prefix="üöí hotfix" ;;  # √† adapter si tu veux diff√©rencier
    chore)   prefix="üßπ chore" ;;
    *)
      echo -e "${YELLOW}‚ö†Ô∏è  Tu dois √™tre sur une branche (feature|fix|hotfix|chore)/* pour cr√©er une PR.${RESET}"
      exit 1
    ;;
  esac

  local title="$prefix($branch_name)"
  local body="${2:-Pull request automatique depuis \`$branch\` vers \`main\`}"

  # Push si n√©cessaire
  git push -u origin "$branch"

  # Cr√©ation de la PR via GitHub CLI
  gh pr create --base main --head "$branch" --title "$title" --body "$body"

  # R√©cup√©ration du lien vers la PR
  local url=$(gh pr view --json url -q ".url")
  echo -e "${GREEN}‚úÖ PR cr√©√©e depuis $branch vers main${RESET}"
  echo -e "üîó Lien : ${BOLD}${url}${RESET}"
}

# Dispatcher
case "$1" in
  start)
    shift
    start_feature "$1"
    ;;
  finish)
    finish_feature
    ;;
  sync)
    sync_branch
    ;;
  pr)
    shift
    open_pr "$@"
    ;;
  help | *)
    print_help
    ;;
esac
