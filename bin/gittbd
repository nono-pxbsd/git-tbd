#!/bin/bash
# gittbd : CLI pour workflow Trunk-Based Development üöÄ
# Version : 2.0.0
# Auteur : nono.pxbsd
# Licence : MIT

set -euo pipefail

# Couleurs pour l'aide
BOLD="\e[1m"
GREEN="\e[32m"
YELLOW="\e[33m"
CYAN="\e[36m"
RESET="\e[0m"

# D√©tection du r√©pertoire d'installation
SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"

# Chargement des biblioth√®ques
if [[ -f "${SCRIPT_DIR}/../lib/config.sh" ]]; then
  LIB_DIR="${SCRIPT_DIR}/../lib"
else
  echo "‚ùå Impossible de trouver les biblioth√®ques. R√©installez gittbd."
  exit 1
fi

source "${LIB_DIR}/config.sh"
source "${LIB_DIR}/utils.sh"
source "${LIB_DIR}/branches.sh"
source "${LIB_DIR}/commands.sh"

# Fonction d'aide
print_help() {
  echo -e "${BOLD}gittbd${RESET} - CLI pour workflow Trunk-Based Development\n"
  echo "Usage :"
  echo "  ${CYAN}gittbd start [type/name]${RESET}      ‚Üí Cr√©e une nouvelle branche (alias: s)"
  echo "  ${CYAN}gittbd finish [options]${RESET}       ‚Üí Merge dans main + suppression (alias: f)"
  echo "  ${CYAN}gittbd publish [branch]${RESET}       ‚Üí Publie la branche sur origin (alias: p)"
  echo "  ${CYAN}gittbd pr [branch]${RESET}            ‚Üí Ouvre une Pull Request"
  echo "  ${CYAN}gittbd mr [branch]${RESET}            ‚Üí Alias de 'pr' (pour GitLab)"
  echo "  ${CYAN}gittbd validate [branch]${RESET}      ‚Üí Valide une PR/MR (alias: v, merge)"
  echo "  ${CYAN}gittbd sync [branch]${RESET}          ‚Üí Synchronise avec origin"
  echo "  ${CYAN}gittbd bump <type>${RESET}            ‚Üí Cr√©e un tag de version (major/minor/patch)"
  echo "  ${CYAN}gittbd help${RESET}                   ‚Üí Affiche cette aide"
  echo ""
  echo "Options globales :"
  echo "  ${YELLOW}SILENT_MODE=true${RESET}           ‚Üí Mode silencieux (minimal)"
  echo "  ${YELLOW}DEBUG_MODE=true${RESET}            ‚Üí Mode debug (verbose)"
  echo "  ${YELLOW}GIT_PLATFORM=gitlab${RESET}        ‚Üí Utilise GitLab au lieu de GitHub"
  echo ""
  echo "Exemples :"
  echo "  gittbd start feature/login-form"
  echo "  gittbd s                          # Mode interactif"
  echo "  gittbd f --pr                     # Finish avec PR"
  echo "  gittbd bump patch"
  echo "  SILENT_MODE=true gittbd validate --assume-yes"
  echo ""
  echo "Configuration :"
  echo "  Fichier : ${LIB_DIR}/config.sh"
  echo "  Variables : DEFAULT_BASE_BRANCH, DEFAULT_MERGE_MODE, etc."
}

# Dispatcher avec raccourcis et alias
case "${1:-help}" in
  start|s)
    shift
    start "$@"
    ;;
  finish|f)
    shift
    finish "$@"
    ;;
  publish|p)
    shift
    publish "$@"
    ;;
  pr|mr)
    shift
    open_pr "$@"
    ;;
  validate|v|merge)
    shift
    validate_pr "$@"
    ;;
  sync)
    shift
    sync_branch_to_remote "$@"
    ;;
  bump|b)
    shift
    bump "$@"
    ;;
  help|--help|-h|*)
    print_help
    ;;
esac
